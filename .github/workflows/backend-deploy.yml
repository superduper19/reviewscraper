name: Backend Deploy

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'api/**'
      - '.ebextensions/**'
      - 'package.json'
      - 'package-lock.json'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'api/**'
      - '.ebextensions/**'
      - 'package.json'
      - 'package-lock.json'

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run tests
      run: npm test
      continue-on-error: true
      
    - name: Build backend
      run: npm run build:api
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION: us-east-2
        DB_HOST: ${{ secrets.DB_HOST }}
        DB_NAME: review_scraper
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        DB_PORT: ${{ secrets.DB_PORT }}
        DB_USER: pgres4548
        DATABASE_TYPE: postgresql
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        S3_BUCKET_NAME: review-scraper-bucket
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-2
        
    - name: Install EB CLI
      run: |
        pip install awsebcli
        
    - name: Setup database password
      run: |
        if [ -z "$DB_PASSWORD" ]; then
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> $GITHUB_ENV
        fi
        
        # Store password in AWS Secrets Manager
        aws secretsmanager update-secret \
          --secret-id review-scraper-db-password \
          --secret-string "${{ secrets.DB_PASSWORD }}" || \
        aws secretsmanager create-secret \
          --name review-scraper-db-password \
          --description "Database password for Review Scraper" \
          --secret-string "${{ secrets.DB_PASSWORD }}"
          
    - name: Deploy to Elastic Beanstalk
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
      run: |
        # Initialize EB if not already done
        if [ ! -d ".elasticbeanstalk" ]; then
          eb init --platform "Node.js 22" --region us-east-2 --profile default
        fi
        
        # Deploy to appropriate environment
        if [ "${{ github.ref }}" == "refs/heads/main" ]; then
          # Set environment variables for production EB environment
          eb setenv -e review-scraper-prod AWS_REGION=us-east-2 DB_NAME=review_scraper DB_USER=pgres4548 DB_PORT=${{ secrets.DB_PORT }} DB_INSTANCE_IDENTIFIER=review-scraper-db DATABASE_TYPE=postgresql S3_BUCKET_NAME=review-scraper-bucket JWT_SECRET='${{ secrets.JWT_SECRET }}' DB_PASSWORD='${{ secrets.DB_PASSWORD }}'
          eb deploy review-scraper-prod
        else
          # Set environment variables for development EB environment
          eb setenv -e review-scraper-dev AWS_REGION=us-east-2 DB_NAME=review_scraper DB_USER=pgres4548 DB_PORT=${{ secrets.DB_PORT }} DB_INSTANCE_IDENTIFIER=review-scraper-db DATABASE_TYPE=postgresql S3_BUCKET_NAME=review-scraper-bucket JWT_SECRET='${{ secrets.JWT_SECRET }}' DB_PASSWORD='${{ secrets.DB_PASSWORD }}'
          eb deploy review-scraper-dev
        fi
        
    - name: Comment deployment status
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const status = '${{ job.status }}';
          const environment = '${{ github.ref }}' === 'refs/heads/main' ? 'production' : 'development';
          const message = status === 'success' 
            ? `✅ Backend deployed successfully to ${environment}!`
            : `❌ Backend deployment failed for ${environment}`;
            
          if (context.eventName === 'pull_request') {
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo