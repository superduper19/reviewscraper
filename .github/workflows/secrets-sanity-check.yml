name: Secrets Sanity Check

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/secrets-sanity-check.yml'

permissions:
  contents: read
  id-token: write

jobs:
  check:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-2
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: ${{ secrets.DB_PORT }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Summarize secrets presence
        shell: bash
        run: |
          declare -a names=(AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY DB_HOST DB_PORT DB_PASSWORD JWT_SECRET)
          echo "## Secrets Presence" >> "$GITHUB_STEP_SUMMARY"
          for n in "${names[@]}"; do
            if [ -n "${!n}" ]; then
              echo "- $n: SET" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "- $n: MISSING" >> "$GITHUB_STEP_SUMMARY"
              echo "::error::$n is missing"
            fi
          done

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS identity
        run: |
          echo "## AWS STS get-caller-identity" >> "$GITHUB_STEP_SUMMARY"
          aws sts get-caller-identity >> "$GITHUB_STEP_SUMMARY"

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Check DB TCP connectivity
        run: |
          echo "## DB Connectivity" >> "$GITHUB_STEP_SUMMARY"
          pg_isready -h "$DB_HOST" -p "$DB_PORT" && echo "pg_isready: OK" >> "$GITHUB_STEP_SUMMARY" || (echo "pg_isready: FAILED" >> "$GITHUB_STEP_SUMMARY"; exit 1)

      - name: Attempt DB login (user=postgres, db=postgres)
        env:
          PGPASSWORD: ${{ env.DB_PASSWORD }}
        run: |
          set -e
          psql "postgresql://postgres:${PGPASSWORD}@${DB_HOST}:${DB_PORT}/postgres" -c "SELECT current_user, current_database();" >> "$GITHUB_STEP_SUMMARY" && exit 0 || echo "Login to postgres/postgres failed" >> "$GITHUB_STEP_SUMMARY"

      - name: Attempt DB login (user=postgres, db=review_scraper)
        if: always()
        env:
          PGPASSWORD: ${{ env.DB_PASSWORD }}
        run: |
          psql "postgresql://postgres:${PGPASSWORD}@${DB_HOST}:${DB_PORT}/review_scraper" -c "SELECT current_user, current_database();" >> "$GITHUB_STEP_SUMMARY" || echo "Login to postgres/review_scraper failed" >> "$GITHUB_STEP_SUMMARY"